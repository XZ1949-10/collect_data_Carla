# é“è·¯å‘½ä»¤æ¥æºè¯¦è§£

## ğŸ“‹ å‘½ä»¤è·å–æµç¨‹

åœ¨ `interactive_data_collection.py` ä¸­ï¼Œé“è·¯å‘½ä»¤çš„è·å–æµç¨‹å¦‚ä¸‹ï¼š

```
1. è·¯å¾„è§„åˆ’ (GlobalRoutePlanner)
   â†“
2. è·¯å¾„è®¾ç½®åˆ° LocalPlanner
   â†“
3. LocalPlanner ç®¡ç†è·¯ç‚¹é˜Ÿåˆ—
   â†“
4. æ¯å¸§æ›´æ–° target_road_option
   â†“
5. ä» target_road_option è·å–å‘½ä»¤
   â†“
6. æ˜ å°„ä¸ºæ•°å€¼å‘½ä»¤ (2.0/3.0/4.0/5.0)
```

---

## ğŸ” è¯¦ç»†æµç¨‹

### æ­¥éª¤1: è·¯å¾„è§„åˆ’ï¼ˆç”Ÿæˆå¸¦å‘½ä»¤çš„è·¯å¾„ï¼‰

**ä½ç½®**ï¼š`interactive_data_collection.py` ç¬¬364è¡Œ

```python
# ä½¿ç”¨ GlobalRoutePlanner è§„åˆ’è·¯å¾„
route = self.route_planner.trace_route(start_point.location, end_point.location)
```

**GlobalRoutePlanner.trace_route()** åšäº†ä»€ä¹ˆï¼š

1. **è®¡ç®—æœ€çŸ­è·¯å¾„**ï¼šä½¿ç”¨ A* ç®—æ³•åœ¨é“è·¯å›¾ä¸­æœç´¢
2. **åˆ†ææ¯ä¸ªè·¯æ®µ**ï¼šåˆ¤æ–­æ˜¯å·¦è½¬ã€å³è½¬ã€ç›´è¡Œè¿˜æ˜¯è½¦é“è·Ÿéš
3. **è¿”å›è·¯å¾„**ï¼š`list[tuple[carla.Waypoint, RoadOption]]`

**RoadOption çš„ç”Ÿæˆé€»è¾‘**ï¼ˆåœ¨ `GlobalRoutePlanner._turn_decision()` ä¸­ï¼‰ï¼š

```python
# å¯¹äºè·¯å¾„ä¸­çš„æ¯ä¸ªè·¯æ®µï¼Œåˆ¤æ–­è½¬å‘ç±»å‹
def _turn_decision(self, i, route):
    """
    åˆ¤æ–­ä» route[i] åˆ° route[i+1] çš„è½¬å‘ç±»å‹
    
    åˆ¤æ–­ä¾æ®ï¼š
    - è®¡ç®—ä¸¤ä¸ªè·¯æ®µçš„èˆªå‘è§’å·®å€¼
    - æ ¹æ®è§’åº¦å·®åˆ¤æ–­æ˜¯ LEFT/RIGHT/STRAIGHT/LANEFOLLOW
    """
    # è·å–å½“å‰è·¯æ®µå’Œç›®æ ‡è·¯æ®µçš„è¿æ¥ç±»å‹
    edge = self._graph.edges[route[i], route[i + 1]]
    road_option = edge['type']  # è¿™ä¸ª type åœ¨æ„å»ºå›¾æ—¶å·²ç»è®¡ç®—å¥½äº†
    
    return road_option
```

**åœ¨æ„å»ºå›¾æ—¶ï¼ŒRoadOption æ˜¯å¦‚ä½•ç¡®å®šçš„**ï¼š

```python
# åœ¨ GlobalRoutePlanner._build_graph() ä¸­
# å¯¹äºæ¯æ¡è¾¹ï¼ˆè·¯æ®µï¼‰ï¼Œè®¡ç®—å…¶ç±»å‹ï¼š

# 1. è®¡ç®—å…¥å£å‘é‡å’Œå‡ºå£å‘é‡çš„è§’åº¦å·®
entry_vector = np.array([...])  # å…¥å£æ–¹å‘
exit_vector = np.array([...])   # å‡ºå£æ–¹å‘

# 2. æ ¹æ®è§’åº¦å·®åˆ¤æ–­è½¬å‘ç±»å‹
angle_diff = calculate_angle(entry_vector, exit_vector)

if angle_diff < 35Â° or angle_diff > 145Â°:
    road_option = RoadOption.STRAIGHT  # ç›´è¡Œ
elif angle_diff > 90Â°:
    road_option = RoadOption.LEFT     # å·¦è½¬
else:
    road_option = RoadOption.RIGHT     # å³è½¬

# 3. å¦‚æœä¸æ˜¯äº¤å‰å£ï¼Œåˆ™æ˜¯ LANEFOLLOW
if not is_intersection:
    road_option = RoadOption.LANEFOLLOW
```

---

### æ­¥éª¤2: è·¯å¾„è®¾ç½®åˆ° LocalPlanner

**ä½ç½®**ï¼š`interactive_data_collection.py` ç¬¬580è¡Œ

```python
# å°†è§„åˆ’å¥½çš„è·¯å¾„è®¾ç½®åˆ° LocalPlanner
self.collector.local_planner.set_global_plan(
    self._current_route,  # [(waypoint, RoadOption), ...]
    stop_waypoint_creation=True,
    clean_queue=True
)
```

**LocalPlanner.set_global_plan()** åšäº†ä»€ä¹ˆï¼š

```python
def set_global_plan(self, current_plan, stop_waypoint_creation=True, clean_queue=True):
    """
    å°†å…¨å±€è·¯å¾„æ·»åŠ åˆ°è·¯ç‚¹é˜Ÿåˆ—
    
    current_plan: [(waypoint, RoadOption), (waypoint, RoadOption), ...]
    """
    if clean_queue:
        self._waypoints_queue.clear()
    
    # å°†è·¯å¾„ä¸­çš„æ¯ä¸ª (waypoint, RoadOption) æ·»åŠ åˆ°é˜Ÿåˆ—
    for elem in current_plan:
        self._waypoints_queue.append(elem)  # é˜Ÿåˆ—å­˜å‚¨ (waypoint, RoadOption)
```

---

### æ­¥éª¤3: LocalPlanner ç®¡ç†è·¯ç‚¹é˜Ÿåˆ—

**è·¯ç‚¹é˜Ÿåˆ—ç»“æ„**ï¼š

```python
self._waypoints_queue = deque([
    (waypoint1, RoadOption.LANEFOLLOW),
    (waypoint2, RoadOption.LANEFOLLOW),
    (waypoint3, RoadOption.LEFT),      # å³å°†å·¦è½¬
    (waypoint4, RoadOption.LEFT),
    (waypoint5, RoadOption.LANEFOLLOW),
    ...
])
```

**é˜Ÿåˆ—ç‰¹ç‚¹**ï¼š
- é˜Ÿåˆ—å·¦ä¾§æ˜¯**å½“å‰ç›®æ ‡è·¯ç‚¹**
- æ¯ä¸ªè·¯ç‚¹éƒ½å¸¦æœ‰å¯¹åº”çš„ `RoadOption`
- `RoadOption` è¡¨ç¤º**åˆ°è¾¾è¯¥è·¯ç‚¹æ—¶çš„åŠ¨ä½œ**

---

### æ­¥éª¤4: æ¯å¸§æ›´æ–° target_road_option

**ä½ç½®**ï¼š`agents/navigation/local_planner.py` çš„ `run_step()` æ–¹æ³•

```python
def run_step(self, debug=False):
    """æ‰§è¡Œä¸€æ­¥å±€éƒ¨è§„åˆ’"""
    
    # 1. æ¸…ç†å·²é€šè¿‡çš„è·¯ç‚¹
    # 2. è¡¥å……è·¯ç‚¹é˜Ÿåˆ—ï¼ˆå¦‚æœéœ€è¦ï¼‰
    
    # 3. è·å–é˜Ÿåˆ—ç¬¬ä¸€ä¸ªè·¯ç‚¹ä½œä¸ºç›®æ ‡
    if len(self._waypoints_queue) > 0:
        self.target_waypoint, self.target_road_option = self._waypoints_queue[0]
        # â†‘ è¿™é‡Œæ›´æ–°äº† target_road_option
    else:
        self.target_road_option = RoadOption.VOID
    
    # 4. è¿”å›æ§åˆ¶æŒ‡ä»¤ï¼ˆæˆ–ç›®æ ‡ä¿¡æ¯ï¼‰
    return control
```

**å…³é”®ç‚¹**ï¼š
- `target_road_option` æ˜¯é˜Ÿåˆ—**ç¬¬ä¸€ä¸ªè·¯ç‚¹**çš„ `RoadOption`
- è¡¨ç¤º**å½“å‰åº”è¯¥æ‰§è¡Œçš„åŠ¨ä½œ**ï¼ˆå·¦è½¬/å³è½¬/ç›´è¡Œ/è½¦é“è·Ÿéšï¼‰

---

### æ­¥éª¤5: ä» target_road_option è·å–å‘½ä»¤

**ä½ç½®**ï¼š`command_based_data_collection.py` çš„ `_get_navigation_command()` æ–¹æ³•

```python
def _get_navigation_command(self):
    """ä» BasicAgent çš„ local_planner è·å–å½“å‰å¯¼èˆªå‘½ä»¤"""
    
    # 1. è·å– BasicAgent çš„ local_planner
    local_planner = self.agent.get_local_planner()
    
    # 2. è·å–å½“å‰ç›®æ ‡è·¯ç‚¹çš„ RoadOption
    road_option = local_planner.target_road_option
    # â†‘ è¿™å°±æ˜¯å½“å‰å‘½ä»¤ï¼
    
    # 3. æ˜ å°„åˆ°æ•°å€¼å‘½ä»¤
    command = self.road_option_to_command.get(road_option, 2.0)
    return command
```

---

### æ­¥éª¤6: æ˜ å°„ä¸ºæ•°å€¼å‘½ä»¤

**ä½ç½®**ï¼š`command_based_data_collection.py` ç¬¬116-124è¡Œ

```python
# RoadOption åˆ°æ•°å€¼å‘½ä»¤çš„æ˜ å°„
self.road_option_to_command = {
    RoadOption.LANEFOLLOW: 2.0,      # Follow
    RoadOption.LEFT: 3.0,            # Left
    RoadOption.RIGHT: 4.0,           # Right
    RoadOption.STRAIGHT: 5.0,        # Straight
    RoadOption.CHANGELANELEFT: 2.0,  # å˜é“ä¹Ÿç®—Follow
    RoadOption.CHANGELANERIGHT: 2.0,
    RoadOption.VOID: 0.0             # åˆ°è¾¾ç›®æ ‡
}
```

**æœ€ç»ˆå‘½ä»¤å€¼**ï¼š
- `2.0` = Followï¼ˆè½¦é“è·Ÿéšï¼‰
- `3.0` = Leftï¼ˆå·¦è½¬ï¼‰
- `4.0` = Rightï¼ˆå³è½¬ï¼‰
- `5.0` = Straightï¼ˆç›´è¡Œï¼‰
- `0.0` = VOIDï¼ˆåˆ°è¾¾ç›®æ ‡ï¼‰

---

## ğŸ“Š å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·¯å¾„è§„åˆ’é˜¶æ®µ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GlobalRoutePlanner.trace_route(start, end)              â”‚
â”‚   â†“                                                      â”‚
â”‚   åˆ†æé“è·¯æ‹“æ‰‘ç»“æ„                                       â”‚
â”‚   â†“                                                      â”‚
â”‚   è®¡ç®—æ¯ä¸ªè·¯æ®µçš„è½¬å‘ç±»å‹ï¼ˆLEFT/RIGHT/STRAIGHT/LANEFOLLOWï¼‰â”‚
â”‚   â†“                                                      â”‚
â”‚   è¿”å›: [(waypoint1, LANEFOLLOW),                       â”‚
â”‚          (waypoint2, LANEFOLLOW),                        â”‚
â”‚          (waypoint3, LEFT),      â† å·¦è½¬è·¯æ®µ              â”‚
â”‚          (waypoint4, LEFT),                               â”‚
â”‚          (waypoint5, LANEFOLLOW), ...]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è·¯å¾„è®¾ç½®é˜¶æ®µ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LocalPlanner.set_global_plan(route)                     â”‚
â”‚   â†“                                                      â”‚
â”‚   å°†è·¯å¾„æ·»åŠ åˆ°è·¯ç‚¹é˜Ÿåˆ—                                   â”‚
â”‚   self._waypoints_queue = deque([                       â”‚
â”‚       (waypoint1, LANEFOLLOW),                          â”‚
â”‚       (waypoint2, LANEFOLLOW),                          â”‚
â”‚       (waypoint3, LEFT),                                â”‚
â”‚       ...                                                â”‚
â”‚   ])                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¿è¡Œæ—¶æ›´æ–°é˜¶æ®µï¼ˆæ¯å¸§ï¼‰                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LocalPlanner.run_step()                                 â”‚
â”‚   â†“                                                      â”‚
â”‚   æ¸…ç†å·²é€šè¿‡çš„è·¯ç‚¹                                       â”‚
â”‚   â†“                                                      â”‚
â”‚   è·å–é˜Ÿåˆ—ç¬¬ä¸€ä¸ªè·¯ç‚¹                                     â”‚
â”‚   self.target_waypoint, self.target_road_option =       â”‚
â”‚       self._waypoints_queue[0]                           â”‚
â”‚   â†“                                                      â”‚
â”‚   target_road_option = LEFT  â† å½“å‰å‘½ä»¤                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‘½ä»¤è·å–é˜¶æ®µ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CommandBasedDataCollector._get_navigation_command()      â”‚
â”‚   â†“                                                      â”‚
â”‚   local_planner = agent.get_local_planner()              â”‚
â”‚   road_option = local_planner.target_road_option        â”‚
â”‚   â†“                                                      â”‚
â”‚   æ˜ å°„åˆ°æ•°å€¼å‘½ä»¤                                         â”‚
â”‚   command = road_option_to_command[road_option]          â”‚
â”‚   â†“                                                      â”‚
â”‚   è¿”å›: 3.0 (Left)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### 1. **å‘½ä»¤æ˜¯åœ¨è·¯å¾„è§„åˆ’æ—¶ç¡®å®šçš„**

- `GlobalRoutePlanner` åœ¨è§„åˆ’è·¯å¾„æ—¶ï¼Œä¼šåˆ†ææ¯ä¸ªè·¯æ®µçš„æ‹“æ‰‘ç»“æ„
- æ ¹æ®é“è·¯çš„å‡ ä½•å½¢çŠ¶ï¼ˆè§’åº¦å·®ï¼‰åˆ¤æ–­æ˜¯å·¦è½¬ã€å³è½¬ã€ç›´è¡Œè¿˜æ˜¯è½¦é“è·Ÿéš
- æ¯ä¸ªè·¯ç‚¹éƒ½å¸¦æœ‰å¯¹åº”çš„ `RoadOption`

### 2. **å‘½ä»¤å­˜å‚¨åœ¨è·¯ç‚¹é˜Ÿåˆ—ä¸­**

- `LocalPlanner` çš„è·¯ç‚¹é˜Ÿåˆ—å­˜å‚¨ `(waypoint, RoadOption)` å¯¹
- é˜Ÿåˆ—å·¦ä¾§æ˜¯å½“å‰ç›®æ ‡è·¯ç‚¹ï¼Œå…¶ `RoadOption` å°±æ˜¯å½“å‰å‘½ä»¤

### 3. **å‘½ä»¤æ˜¯åŠ¨æ€æ›´æ–°çš„**

- æ¯å¸§è°ƒç”¨ `LocalPlanner.run_step()` æ—¶ï¼Œä¼šæ›´æ–° `target_road_option`
- `target_road_option` å§‹ç»ˆæŒ‡å‘é˜Ÿåˆ—ç¬¬ä¸€ä¸ªè·¯ç‚¹çš„ `RoadOption`
- å½“è½¦è¾†é€šè¿‡è·¯ç‚¹åï¼Œé˜Ÿåˆ—ä¼šç§»é™¤è¯¥è·¯ç‚¹ï¼Œä¸‹ä¸€ä¸ªè·¯ç‚¹çš„å‘½ä»¤æˆä¸ºå½“å‰å‘½ä»¤

### 4. **å‘½ä»¤æ˜ å°„å…³ç³»**

```python
RoadOption.LANEFOLLOW  â†’ 2.0 (Follow)
RoadOption.LEFT       â†’ 3.0 (Left)
RoadOption.RIGHT      â†’ 4.0 (Right)
RoadOption.STRAIGHT   â†’ 5.0 (Straight)
RoadOption.VOID       â†’ 0.0 (åˆ°è¾¾ç›®æ ‡)
```

---

## ğŸ’¡ ç¤ºä¾‹

å‡è®¾è§„åˆ’äº†ä¸€æ¡è·¯å¾„ï¼š

```
èµ·ç‚¹ â†’ [LANEFOLLOW] â†’ [LANEFOLLOW] â†’ [LEFT] â†’ [LEFT] â†’ [LANEFOLLOW] â†’ ç»ˆç‚¹
```

**è¿è¡Œæ—¶å‘½ä»¤å˜åŒ–**ï¼š

```
å¸§1-50:  command = 2.0 (Follow)  â† è·Ÿéšè½¦é“
å¸§51-60: command = 3.0 (Left)   â† å‡†å¤‡å·¦è½¬
å¸§61-70: command = 3.0 (Left)   â† æ­£åœ¨å·¦è½¬
å¸§71+:   command = 2.0 (Follow) â† å·¦è½¬å®Œæˆï¼Œç»§ç»­è·Ÿéšè½¦é“
```

---

## ğŸ”§ ä»£ç ä½ç½®æ€»ç»“

| åŠŸèƒ½ | æ–‡ä»¶ | æ–¹æ³• |
|------|------|------|
| **è·¯å¾„è§„åˆ’** | `agents/navigation/global_route_planner.py` | `trace_route()` |
| **å‘½ä»¤ç”Ÿæˆ** | `agents/navigation/global_route_planner.py` | `_turn_decision()` |
| **è·¯å¾„è®¾ç½®** | `agents/navigation/local_planner.py` | `set_global_plan()` |
| **å‘½ä»¤æ›´æ–°** | `agents/navigation/local_planner.py` | `run_step()` |
| **å‘½ä»¤è·å–** | `command_based_data_collection.py` | `_get_navigation_command()` |
| **å‘½ä»¤æ˜ å°„** | `command_based_data_collection.py` | `road_option_to_command` |

---

**æ€»ç»“ï¼šé“è·¯å‘½ä»¤æ˜¯åœ¨è·¯å¾„è§„åˆ’æ—¶æ ¹æ®é“è·¯æ‹“æ‰‘ç»“æ„ç¡®å®šçš„ï¼Œå­˜å‚¨åœ¨è·¯ç‚¹é˜Ÿåˆ—ä¸­ï¼Œæ¯å¸§åŠ¨æ€æ›´æ–°ï¼** ğŸ¯

