# opt_dict 和 map_inst 参数详解

## 📋 参数总览

```python
LocalPlanner(
    vehicle,           # 必需：车辆对象
    opt_dict={},       # 可选：配置字典 ← 自定义规划器行为
    map_inst=None      # 可选：地图对象 ← 性能优化
)
```

---

## 1️⃣ opt_dict - 配置字典

### 🎯 作用

**用于自定义局部规划器的行为参数**，控制路点管理、速度设置等。

### 📊 为什么需要它？

```python
# 不使用 opt_dict（使用默认值）
local_planner = LocalPlanner(vehicle)
# 问题：
# - 速度固定为 20 km/h
# - 路点间距固定为 2 米
# - 无法自定义行为

# 使用 opt_dict（自定义配置）
opt_dict = {'target_speed': 50.0, 'sampling_radius': 1.0}
local_planner = LocalPlanner(vehicle, opt_dict=opt_dict)
# 优势：
# - 速度可以设为 50 km/h
# - 路点间距可以设为 1 米
# - 灵活控制行为
```

### 📝 可配置参数

#### 参数1: `target_speed` - 目标速度

```python
opt_dict = {
    'target_speed': 40.0  # 单位: km/h
}

# 作用：设置期望的行驶速度
# 默认值：20.0 km/h
# 使用场景：
# - 20.0: 城市低速
# - 40.0: 城市正常速度
# - 80.0: 高速公路
```

**示例：**
```python
# 城市驾驶
opt_dict = {'target_speed': 30.0}

# 高速驾驶
opt_dict = {'target_speed': 80.0}
```

#### 参数2: `sampling_radius` - 路点间距

```python
opt_dict = {
    'sampling_radius': 1.5  # 单位: 米
}

# 作用：控制相邻路点之间的距离
# 默认值：2.0 米
# 影响：
# - 值越小：路点越密集，跟踪越精确，计算量越大
# - 值越大：路点越稀疏，跟踪越粗糙，计算量越小
```

**对比：**
```
sampling_radius = 1.0 米（密集）
🚗──📍──📍──📍──📍──📍──📍──📍──📍
   1m  1m  1m  1m  1m  1m  1m  1m
优点：跟踪精确
缺点：路点多，计算量大

sampling_radius = 4.0 米（稀疏）
🚗────────📍────────📍────────📍
       4m        4m        4m
优点：计算量小
缺点：跟踪粗糙，可能偏离路径
```

#### 参数3: `offset` - 车道偏移

```python
opt_dict = {
    'offset': 1.0  # 单位: 米
}

# 作用：让车辆偏离车道中心线
# 默认值：0.0 米（车道中心）
# 正值：向右偏移
# 负值：向左偏移
```

**可视化：**
```
offset = -1.0 (向左)
│     🚗     │  车道
│           │

offset = 0.0 (中心)
│     🚗     │  车道
      ↑
     中心

offset = 1.0 (向右)
│           🚗  车道
```

**使用场景：**
```python
# 靠右行驶（某些国家的习惯）
opt_dict = {'offset': 1.0}

# 靠左行驶
opt_dict = {'offset': -1.0}

# 车道中心（默认）
opt_dict = {'offset': 0.0}
```

#### 参数4: `base_min_distance` - 基础清理距离

```python
opt_dict = {
    'base_min_distance': 3.0  # 单位: 米
}

# 作用：设置清理已通过路点的基础距离阈值
# 默认值：3.0 米
# 用途：当车辆距离路点小于此值时，从队列中移除该路点
```

**工作原理：**
```
实际清理距离 = base_min_distance + distance_ratio × 当前速度

例如：
base_min_distance = 3.0
distance_ratio = 0.5
当前速度 = 30 km/h = 8.3 m/s

清理距离 = 3.0 + 0.5 × 8.3 = 7.15 米

意思：车辆距离路点 < 7.15米 时，认为已通过，从队列移除
```

#### 参数5: `distance_ratio` - 距离比率

```python
opt_dict = {
    'distance_ratio': 0.5
}

# 作用：速度相关的距离调整系数
# 默认值：0.5
# 公式：清理距离 = base_min_distance + distance_ratio × speed
# 影响：速度越快，提前清理路点的距离越远
```

#### 参数6: `follow_speed_limits` - 跟随速度限制

```python
opt_dict = {
    'follow_speed_limits': True
}

# 作用：是否自动跟随道路的速度限制
# 默认值：False
# True: target_speed 会自动设为当前道路的速度限制
# False: 使用固定的 target_speed
```

**示例：**
```python
# 不跟随速度限制（固定速度）
opt_dict = {
    'target_speed': 40.0,
    'follow_speed_limits': False
}
# 结果：始终以 40 km/h 为目标速度

# 跟随速度限制（动态速度）
opt_dict = {
    'follow_speed_limits': True
}
# 结果：
# - 在限速 30 km/h 的道路上 → target_speed = 30
# - 在限速 60 km/h 的道路上 → target_speed = 60
# - 在限速 90 km/h 的道路上 → target_speed = 90
```

### 📊 opt_dict 完整示例

```python
# 完整配置
opt_dict = {
    'target_speed': 30.0,           # 目标速度 30 km/h
    'sampling_radius': 2.0,         # 路点间距 2米
    'offset': 0.0,                  # 车道中心
    'base_min_distance': 3.0,       # 基础清理距离 3米
    'distance_ratio': 0.5,          # 距离比率 0.5
    'follow_speed_limits': False,   # 不跟随速度限制
}

local_planner = LocalPlanner(vehicle, opt_dict=opt_dict)
```

---

## 2️⃣ map_inst - 地图对象

### 🎯 作用

**提供预先获取的地图对象，避免重复调用 `world.get_map()`**

### 📊 为什么需要它？

#### 问题：不传入 map_inst

```python
# 不传入地图
local_planner = LocalPlanner(vehicle)

# 内部会调用（比较耗时）
self._map = self._world.get_map()  # ← 每次初始化都要调用
```

**问题：**
- `world.get_map()` 是一个**耗时操作**（需要从服务器获取地图数据）
- 如果创建多个规划器，会重复调用多次
- 浪费时间和资源

#### 解决：传入 map_inst

```python
# 提前获取地图（只调用一次）
carla_map = world.get_map()  # ← 只调用一次

# 创建多个规划器时复用
planner1 = LocalPlanner(vehicle1, map_inst=carla_map)  # 不再调用 get_map()
planner2 = LocalPlanner(vehicle2, map_inst=carla_map)  # 不再调用 get_map()
planner3 = LocalPlanner(vehicle3, map_inst=carla_map)  # 不再调用 get_map()
```

**优势：**
- ✅ 性能优化：避免重复的耗时操作
- ✅ 代码清晰：地图获取逻辑集中管理
- ✅ 节省资源：减少网络通信

### 📝 使用示例

#### 场景1: 单个规划器（可选）

```python
# 不提供 map_inst（LocalPlanner内部会自动获取）
local_planner = LocalPlanner(vehicle)

# 或提供 map_inst（推荐，更高效）
carla_map = world.get_map()
local_planner = LocalPlanner(vehicle, map_inst=carla_map)
```

#### 场景2: 多个规划器（强烈推荐）

```python
# 提前获取地图（只调用一次）
carla_map = world.get_map()

# 为多辆车创建规划器（复用地图）
planner1 = LocalPlanner(vehicle1, map_inst=carla_map)
planner2 = LocalPlanner(vehicle2, map_inst=carla_map)
planner3 = LocalPlanner(vehicle3, map_inst=carla_map)

# 效率提升：
# - 不传入 map_inst: 调用 get_map() 3次 ⏱️ 慢
# - 传入 map_inst: 调用 get_map() 1次 ⚡ 快
```

#### 场景3: 与 GlobalRoutePlanner 共享地图

```python
# 获取地图一次
carla_map = world.get_map()

# GlobalRoutePlanner 需要地图
global_planner = GlobalRoutePlanner(carla_map, 2.0)

# LocalPlanner 也需要地图（复用同一个）
local_planner = LocalPlanner(vehicle, map_inst=carla_map)

# 优势：两个规划器共享同一个地图对象
```

### 🔍 内部实现

```python
# LocalPlanner.__init__ 中的逻辑
def __init__(self, vehicle, opt_dict={}, map_inst=None):
    self._vehicle = vehicle
    self._world = self._vehicle.get_world()
    
    # 如果提供了 map_inst
    if map_inst:
        if isinstance(map_inst, carla.Map):
            self._map = map_inst  # ← 直接使用
        else:
            print("警告: 不是有效的 carla.Map")
            self._map = self._world.get_map()  # ← 重新获取
    else:
        # 如果没有提供，自动获取
        self._map = self._world.get_map()  # ← 自动获取（耗时）
```

---

## 📊 对比总结

### opt_dict - 配置字典

| 特性 | 说明 |
|------|------|
| **类型** | `dict` |
| **必需性** | 可选 |
| **默认值** | `{}` (空字典) |
| **作用** | 自定义规划器行为参数 |
| **包含参数** | target_speed, sampling_radius, offset 等 |
| **用途** | 控制速度、路点间距、车道偏移等 |
| **典型场景** | 不同驾驶风格、不同道路类型 |

### map_inst - 地图对象

| 特性 | 说明 |
|------|------|
| **类型** | `carla.Map` |
| **必需性** | 可选 |
| **默认值** | `None` (自动获取) |
| **作用** | 避免重复获取地图（性能优化） |
| **获取方式** | `world.get_map()` |
| **用途** | 提高初始化速度，共享地图对象 |
| **典型场景** | 多车辆、与GlobalPlanner共享 |

---

## 💡 实际使用建议

### 建议1: 最简单（快速测试）

```python
# 只传入必需参数
local_planner = LocalPlanner(vehicle)

# 适用场景：
# - 快速测试
# - 使用默认配置即可
# - 单个车辆
```

### 建议2: 自定义配置（常用）

```python
# 自定义行为
opt_dict = {
    'target_speed': 40.0,
    'sampling_radius': 2.0,
}
local_planner = LocalPlanner(vehicle, opt_dict=opt_dict)

# 适用场景：
# - 需要自定义速度
# - 需要调整路点密度
# - 生产环境
```

### 建议3: 完整配置（推荐）

```python
# 性能优化 + 自定义配置
carla_map = world.get_map()  # 提前获取地图

opt_dict = {
    'target_speed': 30.0,
    'sampling_radius': 2.0,
}

local_planner = LocalPlanner(
    vehicle,
    opt_dict=opt_dict,    # 自定义配置
    map_inst=carla_map    # 性能优化
)

# 适用场景：
# - 正式项目
# - 多车辆场景
# - 需要性能优化
```

---

## 🎓 详细示例

### 示例1: opt_dict 的影响

```python
# 场景A: 谨慎驾驶
opt_dict_cautious = {
    'target_speed': 20.0,        # 低速
    'sampling_radius': 1.0,      # 密集路点（精确跟踪）
    'offset': 0.0,               # 车道中心
}

# 场景B: 激进驾驶
opt_dict_aggressive = {
    'target_speed': 60.0,        # 高速
    'sampling_radius': 3.0,      # 稀疏路点（快速计算）
    'offset': 0.0,
}

# 场景C: 靠右行驶
opt_dict_right = {
    'target_speed': 30.0,
    'sampling_radius': 2.0,
    'offset': 1.5,               # 向右偏移1.5米
}

# 创建不同行为的规划器
planner_cautious = LocalPlanner(vehicle, opt_dict=opt_dict_cautious)
planner_aggressive = LocalPlanner(vehicle, opt_dict=opt_dict_aggressive)
planner_right = LocalPlanner(vehicle, opt_dict=opt_dict_right)
```

### 示例2: map_inst 的性能优化

```python
import time

# ========== 方式1: 不使用 map_inst（慢）==========
start_time = time.time()

planner1 = LocalPlanner(vehicle1)  # 调用 get_map() 1次
planner2 = LocalPlanner(vehicle2)  # 调用 get_map() 1次
planner3 = LocalPlanner(vehicle3)  # 调用 get_map() 1次
# 总共调用 3次 get_map()

elapsed_slow = time.time() - start_time
print(f"不使用 map_inst: {elapsed_slow:.3f} 秒")

# ========== 方式2: 使用 map_inst（快）==========
start_time = time.time()

carla_map = world.get_map()  # 调用 get_map() 1次
planner1 = LocalPlanner(vehicle1, map_inst=carla_map)  # 复用
planner2 = LocalPlanner(vehicle2, map_inst=carla_map)  # 复用
planner3 = LocalPlanner(vehicle3, map_inst=carla_map)  # 复用
# 总共调用 1次 get_map()

elapsed_fast = time.time() - start_time
print(f"使用 map_inst: {elapsed_fast:.3f} 秒")

print(f"性能提升: {elapsed_slow / elapsed_fast:.2f}x")

# 输出示例：
# 不使用 map_inst: 0.456 秒
# 使用 map_inst: 0.152 秒
# 性能提升: 3.00x
```

### 示例3: 完整实际应用

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import carla
from agents.navigation.local_planner import LocalPlanner
from agents.navigation.global_route_planner import GlobalRoutePlanner

def create_navigation_system():
    """创建完整的导航系统"""
    
    # 1. 连接CARLA
    client = carla.Client('localhost', 2000)
    world = client.get_world()
    
    # 2. 获取地图（只获取一次）⚡
    carla_map = world.get_map()
    print("✓ 地图已获取")
    
    # 3. 生成车辆
    blueprint_library = world.get_blueprint_library()
    vehicle_bp = blueprint_library.filter('vehicle.tesla.model3')[0]
    spawn_point = carla_map.get_spawn_points()[0]
    vehicle = world.spawn_actor(vehicle_bp, spawn_point)
    print("✓ 车辆已生成")
    
    # 4. 配置参数（根据场景定制）🎛️
    opt_dict = {
        'target_speed': 40.0,        # 目标速度
        'sampling_radius': 2.0,      # 路点间距
        'offset': 0.5,               # 靠右0.5米
        'base_min_distance': 3.0,    # 基础距离
        'distance_ratio': 0.5,       # 距离比率
        'follow_speed_limits': False,# 不跟随限速
    }
    print("✓ 参数已配置")
    
    # 5. 创建全局规划器（复用地图）⚡
    global_planner = GlobalRoutePlanner(carla_map, 2.0)
    print("✓ 全局规划器已创建")
    
    # 6. 创建局部规划器（复用地图）⚡
    local_planner = LocalPlanner(
        vehicle,
        opt_dict=opt_dict,    # ← 自定义配置
        map_inst=carla_map    # ← 性能优化（复用地图）
    )
    print("✓ 局部规划器已创建")
    
    print("\n性能优化说明:")
    print("  - 地图只获取了1次（而不是2次）")
    print("  - global_planner 和 local_planner 共享同一个地图对象")
    
    return world, vehicle, global_planner, local_planner
```

---

## 🎯 总结

### opt_dict 的作用

```
┌─────────────────────────────────────────┐
│         opt_dict 配置字典              │
├─────────────────────────────────────────┤
│  作用：自定义规划器行为                │
│                                         │
│  控制内容：                            │
│  ✓ 速度设置                            │
│  ✓ 路点密度                            │
│  ✓ 车道偏移                            │
│  ✓ 清理距离                            │
│  ✓ 速度限制                            │
│                                         │
│  使用场景：                            │
│  - 不同驾驶风格（谨慎/激进）          │
│  - 不同道路类型（城市/高速）          │
│  - 特殊需求（靠右行驶）               │
└─────────────────────────────────────────┘
```

### map_inst 的作用

```
┌─────────────────────────────────────────┐
│         map_inst 地图对象              │
├─────────────────────────────────────────┤
│  作用：性能优化                        │
│                                         │
│  优化方式：                            │
│  ✓ 避免重复调用 get_map()             │
│  ✓ 多个规划器共享地图                 │
│  ✓ 减少网络通信                       │
│                                         │
│  使用场景：                            │
│  - 多车辆仿真                         │
│  - 与 GlobalPlanner 共享              │
│  - 性能敏感应用                       │
└─────────────────────────────────────────┘
```

---

## ⚡ 快速记忆

```python
LocalPlanner(
    vehicle,           # 必需：车辆对象（要控制谁）
    opt_dict={},       # 可选：配置字典（怎么控制）
    map_inst=None      # 可选：地图对象（性能优化）
)
```

- **vehicle**: "谁" - 要控制的车辆
- **opt_dict**: "怎么控制" - 速度、路点、偏移等配置
- **map_inst**: "性能优化" - 避免重复获取地图

---

**现在你完全理解这两个参数的作用了！** 🎉

