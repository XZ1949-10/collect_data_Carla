# command_based_data_collection.py æ›¿æ¢å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„æ›¿æ¢

### 1. **å¯¼å…¥éƒ¨åˆ†**

**æ›¿æ¢å‰**ï¼š
```python
from navigation_planner import NavigationPlanner

# å°è¯•å¯¼å…¥ BasicAgent
try:
    from agents.navigation.basic_agent import BasicAgent
    BASIC_AGENT_AVAILABLE = True
except ImportError:
    BASIC_AGENT_AVAILABLE = False
```

**æ›¿æ¢å**ï¼š
```python
# å¯¼å…¥ agents æ¨¡å—
try:
    from agents.navigation.basic_agent import BasicAgent
    from agents.navigation.local_planner import RoadOption
    AGENTS_AVAILABLE = True
except ImportError as e:
    AGENTS_AVAILABLE = False
    print(f"âš ï¸  è­¦å‘Š: æ— æ³•å¯¼å…¥ agents æ¨¡å—: {e}")
```

---

### 2. **åˆå§‹åŒ–éƒ¨åˆ†**

**åˆ é™¤**ï¼š
- `self.navigation_planner = None`
- `self.navigation_planner = NavigationPlanner(self.world, sampling_resolution=2.0)`

**æ–°å¢**ï¼š
- `self.road_option_to_command` - RoadOption åˆ°æ•°å€¼å‘½ä»¤çš„æ˜ å°„å­—å…¸

---

### 3. **BasicAgent é…ç½®**

**æ›¿æ¢å‰**ï¼š
```python
if BASIC_AGENT_AVAILABLE:
    self.agent = BasicAgent(self.vehicle, target_speed=30)
    # åˆ†åˆ«é…ç½®å„é¡¹
    if self.ignore_traffic_lights:
        self.agent.ignore_traffic_lights(True)
    # ...
    self.agent.set_destination(destination)
```

**æ›¿æ¢å**ï¼š
```python
if AGENTS_AVAILABLE:
    opt_dict = {
        'target_speed': 30.0,
        'ignore_traffic_lights': self.ignore_traffic_lights,
        'ignore_stop_signs': self.ignore_signs,
        'ignore_vehicles': (self.ignore_vehicles_percentage > 50),
        'sampling_resolution': 2.0
    }
    
    self.agent = BasicAgent(
        self.vehicle, 
        target_speed=30,
        opt_dict=opt_dict,
        map_inst=self.world.get_map()
    )
    
    # è®¾ç½®ç›®çš„åœ°ï¼ˆåŒ…å«èµ·ç‚¹ï¼‰
    start_location = spawn_point.location
    self.agent.set_destination(destination, start_location=start_location)
```

---

### 4. **å¯¼èˆªå‘½ä»¤è·å–**

**æ›¿æ¢å‰**ï¼š
```python
self.current_command = self.navigation_planner.get_navigation_command(self.vehicle)
```

**æ›¿æ¢å**ï¼š
```python
self.current_command = self._get_navigation_command()
```

**æ–°å¢è¾…åŠ©æ–¹æ³•**ï¼š
```python
def _get_navigation_command(self):
    """ä» BasicAgent çš„ local_planner è·å–å½“å‰å¯¼èˆªå‘½ä»¤"""
    if not AGENTS_AVAILABLE or self.agent is None:
        return 2.0  # Follow
    
    try:
        local_planner = self.agent.get_local_planner()
        if local_planner is None:
            return 2.0
        
        road_option = local_planner.target_road_option
        if road_option is None:
            road_option = RoadOption.LANEFOLLOW
        
        command = self.road_option_to_command.get(road_option, 2.0)
        return command
    except Exception as e:
        print(f"âš ï¸  è·å–å¯¼èˆªå‘½ä»¤å¤±è´¥: {e}")
        return 2.0
```

---

### 5. **è·¯çº¿å®Œæˆæ£€æŸ¥**

**æ›¿æ¢å‰**ï¼š
```python
if self.navigation_planner.is_route_completed(self.vehicle):
    break
```

**æ›¿æ¢å**ï¼š
```python
if self._is_route_completed():
    break
```

**æ–°å¢è¾…åŠ©æ–¹æ³•**ï¼š
```python
def _is_route_completed(self):
    """æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®çš„åœ°"""
    if not AGENTS_AVAILABLE or self.agent is None:
        return False
    
    try:
        return self.agent.done()
    except Exception as e:
        print(f"âš ï¸  æ£€æŸ¥è·¯çº¿å®ŒæˆçŠ¶æ€å¤±è´¥: {e}")
        return False
```

---

### 6. **å˜é‡åç»Ÿä¸€**

**æ›¿æ¢**ï¼š
- `BASIC_AGENT_AVAILABLE` â†’ `AGENTS_AVAILABLE`ï¼ˆæ‰€æœ‰å‡ºç°çš„åœ°æ–¹ï¼‰

---

## ğŸ“Š æ›¿æ¢ç»Ÿè®¡

| é¡¹ç›® | æ›¿æ¢å‰ | æ›¿æ¢å |
|------|--------|--------|
| **å¯¼èˆªè§„åˆ’å™¨** | `NavigationPlanner` | `BasicAgent` + `LocalPlanner` |
| **å‘½ä»¤è·å–** | `navigation_planner.get_navigation_command()` | `_get_navigation_command()` |
| **è·¯çº¿å®Œæˆæ£€æŸ¥** | `navigation_planner.is_route_completed()` | `_is_route_completed()` |
| **ç›®çš„åœ°è®¾ç½®** | `navigation_planner.set_destination()` | `agent.set_destination()` |

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

1. âœ… **å®Œå…¨ä½¿ç”¨ agents æ¨¡å—**ï¼šä¸å†ä¾èµ–è‡ªå®šä¹‰çš„ `NavigationPlanner`
2. âœ… **æ›´è§„èŒƒçš„é…ç½®**ï¼šä½¿ç”¨ `opt_dict` ç»Ÿä¸€é…ç½® BasicAgent
3. âœ… **æ›´å¥½çš„é”™è¯¯å¤„ç†**ï¼šæ·»åŠ äº†å¼‚å¸¸å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
4. âœ… **ä»£ç æ›´æ¸…æ™°**ï¼šé€šè¿‡è¾…åŠ©æ–¹æ³•å°è£…å¯¼èˆªå‘½ä»¤è·å–é€»è¾‘

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

æ›¿æ¢åçš„ä»£ç å®Œå…¨å…¼å®¹åŸæœ‰åŠŸèƒ½ï¼Œä½†ï¼š

1. **éœ€è¦ agents æ¨¡å—**ï¼šç¡®ä¿ `agents/navigation/` ç›®å½•å­˜åœ¨
2. **å‘½ä»¤æ˜ å°„**ï¼šRoadOption è‡ªåŠ¨æ˜ å°„åˆ°æ•°å€¼å‘½ä»¤ï¼ˆ2.0/3.0/4.0/5.0ï¼‰
3. **é™çº§æ–¹æ¡ˆ**ï¼šå¦‚æœ agents ä¸å¯ç”¨ï¼Œä¼šä½¿ç”¨é»˜è®¤å‘½ä»¤ï¼ˆFollowï¼‰

---

## âœ… éªŒè¯

- âœ… æ‰€æœ‰ `navigation_planner` å¼•ç”¨å·²åˆ é™¤
- âœ… æ‰€æœ‰ `NavigationPlanner` å¼•ç”¨å·²åˆ é™¤
- âœ… æ‰€æœ‰ `BASIC_AGENT_AVAILABLE` å·²æ›¿æ¢ä¸º `AGENTS_AVAILABLE`
- âœ… è¾…åŠ©æ–¹æ³•å·²æ·»åŠ 
- âœ… ä»£ç é€šè¿‡ linter æ£€æŸ¥

**æ›¿æ¢å®Œæˆï¼** ğŸ‰


